<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Đình Hường & Khánh Linh</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; }
        #overlay {
            position: absolute; bottom: 10%; width: 100%;
            text-align: center; color: #ffb6c1;
            font-family: sans-serif; letter-spacing: 2px;
            pointer-events: none; font-size: 11px; opacity: 0.8;
            animation: blink 2s infinite; z-index: 100;
        }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.9; } }
    </style>
</head>
<body>
    <div id="overlay">CHẠM VÀO TRÁI TIM</div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- CẤU HÌNH ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        camera.position.z = 15;

        const messages = ["Đình Hường <3 Khánh Linh", "13.05.2023", "1000 days", "Happy valentine day", "Love you forever"];
        let currentMsgIndex = -1;
        let state = "WAIT"; 
        
        // --- GEOMETRY TRÁI TIM SIÊU NHỎ ---
        const heartShape = new THREE.Shape();
        heartShape.moveTo(0, 0);
        heartShape.bezierCurveTo(0.1, 0.1, 0.2, 0, 0, -0.2);
        heartShape.bezierCurveTo(-0.2, 0, -0.1, 0.1, 0, 0);
        const miniHeartGeo = new THREE.ShapeGeometry(heartShape);

        // --- MESH 1: TRÁI TIM 3D CHÍNH ---
        const countHeart = 6000;
        const heartMesh = new THREE.InstancedMesh(miniHeartGeo, new THREE.MeshBasicMaterial({ 
            transparent: true, blending: THREE.AdditiveBlending, side: THREE.DoubleSide 
        }), countHeart);
        scene.add(heartMesh);

        // --- MESH 2: DÒNG CHỮ (Tách biệt để điều khiển riêng) ---
        const countText = 4000;
        const textMesh = new THREE.InstancedMesh(miniHeartGeo, new THREE.MeshBasicMaterial({ 
            transparent: true, blending: THREE.AdditiveBlending, side: THREE.DoubleSide 
        }), countText);
        textMesh.visible = false;
        scene.add(textMesh);

        const dummy = new THREE.Object3D();
        const heartPos = [];
        const heartTarget = [];
        const textPos = [];
        const colors = [];

        function isInsideHeart(x, y, z) {
            const x2 = x * x, y2 = y * y, z2 = z * z;
            return Math.pow(x2 + (2.25)*y2 + z2 - 1, 3) - x2*z2*z - (0.1125)*y2*z2*z <= 0;
        }

        // Khởi tạo trái tim 3D
        for (let i = 0; i < countHeart; i++) {
            let pt = new THREE.Vector3();
            do {
                pt.set((Math.random()-0.5)*3.5, (Math.random()-0.5)*3.5, (Math.random()-0.5)*3.5);
            } while (!isInsideHeart(pt.x, pt.y, pt.z));
            
            heartTarget.push(new THREE.Vector3(pt.x * 4, pt.z * 4, -pt.y * 4));
            heartPos.push(new THREE.Vector3().copy(heartTarget[i]));
            colors.push(new THREE.Color().setHSL(Math.random() * 0.1 + 0.95, 1, 0.7));
        }

        // Khởi tạo mảng vị trí cho chữ
        for (let i = 0; i < countText; i++) {
            textPos.push(new THREE.Vector3(0, 0, 0));
        }

        // --- HÀM XỬ LÝ CHỮ (Sửa lỗi lật chữ) ---
        function getTextPoints(text) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1000; canvas.height = 300;
            ctx.clearRect(0, 0, 1000, 300);
            ctx.fillStyle = 'white';
            ctx.font = '70px "Great Vibes"';
            ctx.textAlign = 'center';
            // Không dùng scale âm nữa, vẽ trực tiếp và lấy tọa độ chuẩn
            ctx.fillText(text, 500, 150);
            
            const data = ctx.getImageData(0, 0, 1000, 300).data;
            const pts = [];
            for (let y = 0; y < 300; y += 4) {
                for (let x = 0; x < 1000; x += 4) {
                    if (data[(y * 1000 + x) * 4 + 3] > 128) {
                        pts.push(new THREE.Vector3((x - 500) * 0.025, -(y - 150) * 0.025, 2)); // Z=2 để hiện lên trước
                    }
                }
            }
            return pts;
        }

        let currentTextPoints = [];

        // --- PHÁO HOA ---
        const fireworks = [];
        function createFirework() {
            const pCount = 40;
            const geo = new THREE.BufferGeometry();
            const posArr = new Float32Array(pCount * 3);
            const vels = [];
            const origin = new THREE.Vector3((Math.random()-0.5)*25, -18, (Math.random()-0.5)*10 - 10);
            for(let i=0; i<pCount; i++) {
                posArr[i*3]=origin.x; posArr[i*3+1]=origin.y; posArr[i*3+2]=origin.z;
                vels.push(new THREE.Vector3((Math.random()-0.5)*0.2, Math.random()*0.4+0.3, (Math.random()-0.5)*0.2));
            }
            geo.setAttribute('position', new THREE.BufferAttribute(posArr, 3));
            const points = new THREE.Points(geo, new THREE.PointsMaterial({
                size: 0.15, color: new THREE.Color().setHSL(Math.random(), 1, 0.6), transparent: true, blending: THREE.AdditiveBlending
            }));
            scene.add(points);
            fireworks.push({ points, vels, life: 1.5 });
        }

        function nextMessage() {
            currentMsgIndex++;
            if (currentMsgIndex < messages.length) {
                currentTextPoints = getTextPoints(messages[currentMsgIndex]);
                setTimeout(nextMessage, 4000);
            }
        }

        // --- ANIMATION ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const t = clock.getElapsedTime();

            // 1. Cập nhật Trái tim 3D (Luôn tồn tại)
            const heartRotationSpeed = (state === "WAIT") ? 0.01 : 0.002;
            heartMesh.rotation.y += heartRotationSpeed;
            const heartOpacity = (state === "WAIT") ? 1.0 : 0.4;

            for (let i = 0; i < countHeart; i++) {
                dummy.position.copy(heartPos[i]);
                const s = 0.5 + Math.sin(t * 2 + i) * 0.1;
                dummy.scale.set(s, s, s);
                dummy.lookAt(camera.position);
                dummy.updateMatrix();
                heartMesh.setMatrixAt(i, dummy.matrix);
                heartMesh.setColorAt(i, colors[i].clone().multiplyScalar(heartOpacity));
            }
            heartMesh.instanceMatrix.needsUpdate = true;
            heartMesh.instanceColor.needsUpdate = true;

            // 2. Cập nhật Chữ (Khi đã bấm)
            if (state === "PLAYING") {
                textMesh.visible = true;
                const jitter = Math.sin(t * 12) * 0.02;
                for (let i = 0; i < countText; i++) {
                    const target = currentTextPoints[i % currentTextPoints.length] || new THREE.Vector3(0,0,0);
                    textPos[i].lerp(new THREE.Vector3(target.x + jitter, target.y + jitter, target.z), 0.06);
                    dummy.position.copy(textPos[i]);
                    dummy.scale.set(0.4, 0.4, 0.4);
                    dummy.lookAt(camera.position);
                    dummy.updateMatrix();
                    textMesh.setMatrixAt(i, dummy.matrix);
                    textMesh.setColorAt(i, new THREE.Color(0xffffff));
                }
                textMesh.instanceMatrix.needsUpdate = true;
                textMesh.instanceColor.needsUpdate = true;
            }

            // 3. Pháo hoa
            if (Math.random() < 0.07) createFirework();
            for (let i = fireworks.length - 1; i >= 0; i--) {
                const f = fireworks[i];
                const pAttr = f.points.geometry.attributes.position;
                for (let j = 0; j < 40; j++) {
                    pAttr.setX(j, pAttr.getX(j) + f.vels[j].x);
                    pAttr.setY(j, pAttr.getY(j) + f.vels[j].y);
                    pAttr.setZ(j, pAttr.getZ(j) + f.vels[j].z);
                    f.vels[j].y -= 0.006;
                }
                pAttr.needsUpdate = true;
                f.life -= 0.01;
                f.points.material.opacity = f.life;
                if (f.life <= 0) {
                    scene.remove(f.points);
                    fireworks.splice(i, 1);
                }
            }

            renderer.render(scene, camera);
        }

        // --- XỬ LÝ CLICK ---
        window.addEventListener('pointerdown', () => {
            if (state === "WAIT") {
                state = "PLAYING";
                document.getElementById('overlay').style.display = 'none';
                // Tạo hiệu ứng nổ lan tỏa cho trái tim 3D lúc bấm
                for (let i = 0; i < countHeart; i++) {
                    heartPos[i].multiplyScalar(1.5);
                }
                nextMessage();
                if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            }
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>